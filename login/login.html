<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>登录页</title>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible_css.debug.js"></script>
		<script src="../js/flexible.debug.js"></script>
		<link href="../css/login.css" rel="stylesheet" />
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>

	<body>
		<div class="login-container">
			<div class="header-control header-control-greenBold">
				<div class="header-control-left-btn  mui-action-back">
					<span class="white-arrow-big-span header-control-left-btn-span"></span>
				</div>
				<div>
					<span id="webview-head-title"></span>
				</div>
				<div class="header-control-right-btn" id="register">
					<span class="header-control-right-btn-span">注册</span>
				</div>
			</div>
			<div id="head-holder"></div>
			<div class="input-group">
				<input id="input-phone" class="login-input" type="text" placeholder="手机号" />
				<br />
				<input id="input-pwd" class="login-input" type="password" placeholder="请输入密码" />

				<br />
				<button id="login" class="login-btn btnUnable">登录</button>
				<br />
				<span class="forgetPWD-span">
					<a id="forgetPWD">忘记密码</a>
				</span>
			</div>
			<div class="other-way">
				<span class="other-way-text">其他登录方式</span>
				<span class="other-way-line"></span>
			</div>
			<div class="other-btn">
				<div class="other-btn-item">
					<span class="other-btn-logo logo-weixin"></span>
					<span class="other-btn-title">微信</span>
				</div>
				<div class="other-btn-holder"></div>
				<div class="other-btn-item">
					<span class="other-btn-logo logo-qq"></span>
					<span class="other-btn-title">QQ</span>
				</div>
				<div class="other-btn-holder"></div>
				<div class="other-btn-item">
					<span class="other-btn-logo logo-weibo"></span>
					<span class="other-btn-title">微博</span>
				</div>
			</div>
		</div>

		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js"></script>
		<script src="../js/public.js"></script>
		<script>
			mui.init();
			var phoneInput = document.getElementById("input-phone");
			var pwdInput = document.getElementById("input-pwd");
			var btnLogin = document.getElementById("login");
			var btnAble = false;
			//校验输入
			function checkLogin() {
				var phoneVal = phoneInput.value;
				var pwdVal = pwdInput.value;
				var data = {
					phone: phoneVal,
					password: pwdVal
				};
				if (phoneVal.length != 11) {
					mui.toast("账户不存在");
					return false;
				}
				if (pwdVal.length < 6 || 16 < pwdVal.length) {
					mui.toast("密码错误");
					return false;
				}
				return data;
			};
			//改变登录按钮状态
			function checkInput() {
				var val1 = pwdInput.value;
				var val2 = phoneInput.value;
				if (val1.length != 0 && val2.length != 0) {
					if (btnLogin.classList.contains("btnUnable")) {
						btnLogin.classList.remove("btnUnable");
					}
					btnAble = true;
				} else {
					btnLogin.classList.add("btnUnable");
					btnAble = false;
				}
			};
			var lastval = "";
			phoneInput.addEventListener("input", function() {
				var val = this.value;
				var reg = /^[0-9]*$/;
				if (!val.match(reg)) {
					this.value = lastval;
				} else {
					lastval = val.match(reg);
				}
				checkInput();
			});
			pwdInput.addEventListener("input", checkInput);
			btnLogin.addEventListener("tap", function(e) {
				if (!btnAble) {
					return;
				}
				var dataPost = checkLogin();
				if (typeof dataPost !== "object") {
					return;
				}
				btnAble = false;
				var nwaiting = plus.nativeUI.showWaiting("正在登录");
				var URL = "http://farm.rrzuji.com/v1/users/login?" + fnCreateSign();
				mui.ajax(URL, {
					type: "POST",
					data: dataPost,
					dataType: "JSON",
					timeout: 10000,
					success: function(res) {
						res = JSON.parse(res);
						nwaiting.close();
						btnAble = true;
						if (res.success) {
							plus.storage.setItem("tokenValue", res.data.access_token);
							plus.storage.setItem("tokenDate", new Date().getTime().toString());
							var w = plus.getWebviewById("login.html");
							w.hide();
							w.close();
							mui.toast("登录成功");
						} else {
							mui.toast(res.data.message || res.data.error || "服务器错误");
						}
					},
					error: function(xhr, type, errorThrown) {
						nwaiting.close();
						btnAble = true;
						var res = JSON.parse(xhr.response);
						if (typeof res.data.message !== "undefined") {
							mui.toast(res.data.message);
						}
					}
				});
			});
			mui.plusReady(function() {
				document.getElementById("register").addEventListener("tap", function() {
					var w = plus.webview.create("register.html", "register.html");
					w.onloaded = function() {
						mui.fire(w, "countDown", {});
						w.show("pop-in", 300);
					}
				});
				document.getElementById("forgetPWD").addEventListener("tap", function(e) {
					var w = plus.webview.create("forgetPassword.html", "forgetPassword.html");
					w.onloaded = function() {
						mui.fire(w, "countDown", {});
						w.show("pop-in", 300);
					}
				});
			});
		</script>
	</body>

</html>