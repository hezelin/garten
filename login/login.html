<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>登录页</title>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible_css.debug.js"></script>
		<script src="../js/flexible.debug.js"></script>
		<link href="../css/login.css" rel="stylesheet" />
		<style>
			html,
			body {
				background-color: rgb(246, 246, 246);
				width: 100%;
				height: 100%;
				/*background-color: #efeff4;*/
			}
		</style>
	</head>

	<body>
		<div class="login-container">
			<div class="btn-left mui-action-back">
				<span class="white-arrow-big-span left-28px"></span>
			</div>
			<div id="register" class="btn-right">
				<span>注册</span>
			</div>
			<div class="input-group">
				<span class="login-input-span">
					<input id="input-phone"  class="login-input" type="text" placeholder="手机号"/>
				</span>
				<br />
				<span class="login-input-span">								
					<input id="input-pwd" class="login-input" type="password" placeholder="请输入密码"/>
				</span>
				<br />
				<button id="login" class="login-btn btnUnable">登录</button>
				<br />
				<span class="forgetPWD-span">
					<a id="forgetPWD">忘记密码</a>
				</span>
			</div>
		</div>

		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js"></script>
		<script src="../js/public.js"></script>
		<script>
			mui.init();
			var phoneInput = document.querySelector("#input-phone");
			var pwdInput = document.querySelector("#input-pwd");
			var btnLogin = document.querySelector("#login");
			var btnAble = false;
			//校验输入
			function checkLogin() {
				var phoneVal = phoneInput.value;
				var pwdVal = pwdInput.value;
				var data = {
					phone: phoneVal,
					password: pwdVal
				};
				if (phoneVal.length != 11) {
					mui.toast("账户名不存在");
					return false;
				}
				if (pwdVal.length < 6 || 16 < pwdVal.length) {
					mui.toast("密码错误");
					return false;
				}
				return data;
			};
			//改变登录按钮状态
			function checkInput() {
				var val1 = pwdInput.value;
				var val2 = phoneInput.value;
				if (val1.length != 0 && val2.length != 0) {
					if (btnLogin.classList.contains("btnUnable")) {
						btnLogin.classList.remove("btnUnable");
					}
					btnAble = true;
				} else {
					btnLogin.classList.add("btnUnable");
					btnAble = false;
				}
			};
			var lastval = "";
			phoneInput.addEventListener("input", function() {
				var val = this.value;
				var reg = /^[0-9]*$/;
				if (!val.match(reg)) {
					this.value = lastval;
				} else {
					lastval = val.match(reg);
				}
				checkInput();
			});
			pwdInput.addEventListener("input", checkInput);
			btnLogin.addEventListener("tap", function(e) {
				if (!btnAble) {
					return;
				}
				var dataPost = checkLogin();
				if (typeof dataPost !== "object") {
					return;
				}
				btnAble = false;
				var nwaiting = plus.nativeUI.showWaiting("正在登录");
				var URL = "http://farm.rrzuji.com/v1/users/login?" + fnCreateSign();
				mui.ajax(URL, {
					type: "POST",
					data: dataPost,
					dataType: "JSON",
					timeout: 10000,
					success: function(res) {
						res = JSON.parse(res);
						console.log(JSON.stringify(res));
						nwaiting.close();
						btnAble = true;
						if (res.success) {
							plus.storage.setItem("tokenValue", res.data.access_token);
							plus.storage.setItem("tokenDate", new Date().getTime().toString());
							plus.webview.close("login.html");
							mui.toast("登录成功");
							//检查是否有额外值，有就跳转到目标
							var w = plus.webview.getWebviewById("login.html");
							if (typeof w.operateView === "string") {
								//额外参数说明：
								//operateView 操作目标view , hideView隐藏, showView显示，targetView该属性只用在index页
								mui.fire(plus.webview.getWebviewById(w.operateView), "changeTab", {
									targetView: w.targetView,
									showView: w.showView,
									hideView: w.hideView
								});
							}
						} else {
							mui.toast(res.data.message || res.data.error || "服务器错误");
						}
					},
					error: function(xhr, type, errorThrown) {
						nwaiting.close();
						btnAble = true;
						mui.toast("无法连接服务器");
					}
				});
			});
			mui.plusReady(function() {
				document.querySelector("#register").addEventListener("tap", function() {
					var w = plus.webview.open("register.html", "register.html", {}, "slide-in-right");
					w.onloaded = function() {
						mui.fire(w, "countDown", {});
					}
				});
				document.querySelector("#forgetPWD").addEventListener("tap", function(e) {
					var w = plus.webview.create("forgetPassword.html", "forgetPassword.html", {}, "slide-in-right");
					w.onloaded = function() {
						mui.fire(w, "countDown", {});
						w.show();
					}
				});
			});
		</script>
	</body>

</html>