<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>注册第一页</title>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible_css.debug.js"></script>
		<script src="../js/flexible.debug.js"></script>
		<link href="../css/login.css" rel="stylesheet" />
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
				background-color: rgb(245, 245, 245);
				/*background-color: #efeff4;*/
			}
		</style>
	</head>

	<body>
		<div class="header-control">
			<div class="header-control-left-btn  mui-action-back">
				<span class="white-arrow-big-span header-control-left-btn-span"></span>
			</div>
			<div>
				<span id="webview-head-title">手机快速注册</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span"></span>
			</div>
		</div>
		<div id="head-holder"></div>
		<div class="input-group">
			<input type="text" class="register-input" id="phone-register" placeholder="请输入手机号" />
			<br />
			<span class="authCode-group">
				<input type="text" id="authCode" placeholder="请输入短信验证码"/>
				<button id="getAuthCode">获取验证码</button>
				<!--reSendAuthCode-->
			</span>
			<br />
			<button id="nextRegister" class="register-btn btnUnable">下一步</button>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js"></script>
		<script src="../js/public.js"></script>
		<script>
			mui.init();
			var inputPhone = document.querySelector("#phone-register");
			var inputAuthCode = document.querySelector("#authCode");
			var btnAuthCode = document.querySelector("#getAuthCode");
			var btnNext = document.querySelector("#nextRegister");
			var btnAble = false;
			var btnAble2 = false; //防止多次提交验证码获取
			var reg = /^[0-9]*$/;
			var lastInputAuthCode = "",
				lastInputPhone = "";
			//改变下一步按钮状态
			function checkInputStrict() {
				// 要求是号段正确，11位的手机号码
				// 6位数字验证码
				var val = inputAuthCode.value;
				var val2 = val.match(reg).toString();
				if (checkPhoneInput() && val.length == 6 && val2.length == 6) {
					if (btnNext.classList.contains("btnUnable")) {
						btnNext.classList.remove("btnUnable");
					}
					btnAble = true;
				} else {
					btnNext.classList.add("btnUnable");
					btnAble = false;
				}
			};
			//验证手机号码是否为规范，规范才能发验证码、点击下一步
			function checkPhoneInput() {
				var val = inputPhone.value;
				if (!/^(13|14|15|17|18)\d{9}$/.test(val)) {
					return false;
				} else {
					return true;
				}
			};
			inputPhone.addEventListener("input", function() {
				var val = this.value;
				if (!val.match(reg)) {
					this.value = lastInputPhone;
				} else {
					lastInputPhone = val.match(reg);
				}
				checkInputStrict();
			});
			inputAuthCode.addEventListener("input", function() {
				var val = this.value;
				if (!val.match(reg)) {
					this.value = lastInputAuthCode;
				} else {
					lastInputAuthCode = val.match(reg);
				}
				checkInputStrict();
			});
			window.addEventListener("countDown", function() {
				//打开页面时，检查计时情况
				timew.start();
			});
			mui.plusReady(function() {
				//申请验证码
				btnAuthCode.addEventListener("tap", function() {
					if (!checkPhoneInput()) {
						plus.nativeUI.alert("请输入正确的手机号", function() {}, "提示", "返回");
						return;
					}
					if (NetWorkStatus()) {
						return;
					}
					var nowTime = new Date().getTime().toString();
					var startTime = plus.storage.getItem("authCodeTime");
					if (startTime == null || (nowTime - startTime) / 1000 > 120) {
						// 申请验证码
						var URL = "http://farm.rrzuji.com/v1/code/create?" + fnCreateSign();
						if (!btnAble2) {
							btnAble2 = true;
							var nwaiting = plus.nativeUI.showWaiting("正在发送");
							mui.ajax(URL, {
								type: "POST",
								dataType: "JSON",
								data: {
									"phone": inputPhone.value
								},
								success: function(res) {
									res = JSON.parse(res);
									nwaiting.close();
									btnAble2 = false;
									if (res.success) {
										//更新验证码，验证码接收时间，安全码
										plus.storage.setItem("authCodeTime", new Date().getTime().toString());
										plus.storage.setItem("authCodeToken", res.data.code_token);
										plus.storage.setItem("resPhone", inputPhone.value);
										timew.start();
										mui.toast("验证码已发送至您的手机上");
									} else {
										mui.toast(res.data.message || res.data.error || "服务器错误");
									}									
								},
								error: function(xhr, type, errorThrown) {
									nwaiting.close();
									btnAble2 = false;
									var res = JSON.parse(xhr.response);
									if (typeof res.data.message !== "undefined") {
										mui.toast(res.data.message);
									}
								}
							});
						}
					}
				});
				btnNext.addEventListener("tap", function() {
					if (!btnAble) {
						return;
					}
					if (NetWorkStatus()) {
						return;
					}
					
					// 提交验证码,验证正确后打开下一个页面
					var token = plus.storage.getItem("authCodeToken");
					if (token != null) {
						btnAble = false;
						var nwaiting = plus.nativeUI.showWaiting("正在验证手机");
						var URL = "http://farm.rrzuji.com/v1/code/check?" + fnCreateSign() + "&code-token=" + token;
						mui.ajax(URL, {
							type: "POST",
							dataType: "JSON",
							data: {
								"code": inputAuthCode.value,
							},
							success: function(res) {
								res = JSON.parse(res);
								nwaiting.close();
								if (res.success) {
									var w = plus.webview.create("register2.html", "register2.html");
									w.onloaded = function() {
										w.show("pop-in", 300);
									}
								} else {
									mui.toast(res.data.message || res.data.error || "服务器错误");
								}
								btnAble = true;
							},
							error: function(xhr, type, errorThrown) {
								nwaiting.close();
								btnAble = true;
								var res = JSON.parse(xhr.response);
								if (typeof res.data.message !== "undefined") {
									mui.toast(res.data.message);
								}
							}
						});
					} else {
						mui.toast("验证码无效");
					}
				});
			});
		</script>
	</body>

</html>