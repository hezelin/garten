<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>重置密码</title>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible_css.debug.js"></script>
		<script src="../js/flexible.debug.js"></script>
		<link href="../css/login.css" rel="stylesheet" />
	</head>

	<body>
		<div class="header-control">
			<div class="header-control-left-btn  mui-action-back">
				<span class="white-arrow-big-span header-control-left-btn-span"></span>
			</div>
			<div>
				<span id="webview-head-title">重置密码</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span"></span>
			</div>
		</div>
		<div id="head-holder"></div>
		<div class="input-group">
			<div class="reset-group">
				<div class="reset-item">
					<div class="reset-item-cell reset-item-cell-left">手机号</div>
					<div class="reset-item-cell">
						<input type="text" id="phone-reset" class="reset-item-input reset-item-cell-mid" placeholder="请输入手机号码" />
					</div>
				</div>
				<div class="reset-item">
					<div class="reset-item-cell reset-item-cell-left">验证码</div>
					<div class="reset-item-cell">
						<input type="text" class="reset-item-input reset-item-cell-mid" id="authCodeInput" placeholder="请输入验证码" />
					</div>
					<div class="reset-item-cell">
						<button id="getAuthCode" class="resetAuth">获取验证码</button>
					</div>
				</div>
				<div class="reset-item">
					<div class="reset-item-cell reset-item-cell-left">设置密码</div>
					<div class="reset-item-cell">
						<input type="password" id="input-pwd-reSet" class="reset-item-input reset-item-cell-mid" placeholder="6至16位密码" />
					</div>
				</div>
				<div class="reset-item">
					<div class="reset-item-cell reset-item-cell-left">确认密码</div>
					<div class="reset-item-cell">
						<input type="password" id="input-pwd-confirm" class="reset-item-input reset-item-cell-mid" placeholder="请再次输入密码" />
					</div>
				</div>
			</div>
			<br />
			<span id="back">返回登录</span>
			<br />
			<button id="resetPWD" class="btnUnable">重置密码</button>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js"></script>
		<script src="../js/public.js"></script>
		<script>
			mui.init();
			var inputPhone = document.querySelector("#phone-reset");
			var inputAuthCode = document.querySelector("#authCodeInput");
			var btnAuthCode = document.querySelector("#getAuthCode");
			var inputPWD = document.querySelector("#input-pwd-reSet");
			var inputPWDConfirm = document.querySelector("#input-pwd-confirm");
			var btnNext = document.querySelector("#resetPWD");
			var btnAble = false; //防止多次点击提交按钮
			var btnAble2 = false; //防止多次提交验证码获取
			var reg = /^[0-9]*$/;
			var lastInputAuthCode = "",
				lastInputPhone = "";

			function checkInputStrict() {
				// 要求是号段正确，11位的手机号码
				// 6位数字验证码
				// 6~16位密码
				var val = inputAuthCode.value;
				var val2 = val.match(reg).toString();
				var val3 = inputPWD.value;
				var val4 = inputPWDConfirm.value;
				var result = true;
				switch (true) {
					case !checkPhoneInput():
						result = false;
						break;
					case val.length != 6:
						result = false;
						break;
					case val2.length != 6:
						result = false;
						break;
					case val3.length < 6 || 16 < val3.length:
						result = false;
						break;
					case val4.length < 6 || 16 < val4.length:
						result = false;
						break;
					case val3 != val4:
						result = false;
						mui.toast("两次密码输入不一致，请重新输入");
						break;
					default:
						result = true;
						break;
				}
				if (result) {
					if (btnNext.classList.contains("btnUnable")) {
						btnNext.classList.remove("btnUnable");
					}
					btnAble = true;
				} else {
					btnNext.classList.add("btnUnable");
					btnAble = false;
				}
			};
			//验证手机号码是否为规范，规范才能发验证码、点击下一步
			function checkPhoneInput() {
				var val = inputPhone.value;
				if (!/^(13|14|15|17|18)\d{9}$/.test(val)) {
					return false;
				} else {
					return true;
				}
			};
			/**
			 * @description 验证两次密码输入，成功返回新密码，失败则返回false
			 */
			function pwdConfirm() {
				var val1 = inputPWD.value;
				var val2 = inputPWDConfirm.value;
				if (val1 != val2) {
					return false;
				} else {
					return val1;
				}
			};
			inputPhone.addEventListener("input", function() {
				var val = this.value;
				if (!val.match(reg)) {
					this.value = lastInputPhone;
				} else {
					lastInputPhone = val.match(reg);
				}
				checkInputStrict();
			});
			inputAuthCode.addEventListener("input", function() {
				var val = this.value;
				if (!val.match(reg)) {
					this.value = lastInputAuthCode;
				} else {
					lastInputAuthCode = val.match(reg);
				}
				checkInputStrict();
			});
			inputPWD.addEventListener("input", function() {
				checkInputStrict();
			});
			inputPWDConfirm.addEventListener("input", function() {
				checkInputStrict();
			});
			document.querySelector("#back").addEventListener("tap", function() {
				mui.back();
			});
			window.addEventListener("countDown", function() {
				//打开页面时，检查计时情况
				timew.start();
			});
			mui.plusReady(function() {
				//申请验证码
				btnAuthCode.addEventListener("tap", function() {
					if (!checkPhoneInput()) {
						plus.nativeUI.alert("请输入正确的手机号", function() {}, "提示", "返回");
						return;
					}
					if (NetWorkStatus()) {
						return;
					}		
					var nowTime = new Date().getTime().toString();
					var startTime = plus.storage.getItem("authCodeTime");
					if (startTime == null || (nowTime - startTime) / 1000 > 120) {
						// 申请验证码
						var URL = "http://farm.rrzuji.com/v1/code/create?" + fnCreateSign();
						if (!btnAble2) {
							btnAble2 = true;
							var nwaiting = plus.nativeUI.showWaiting("正在发送");
							mui.ajax(URL, {
								type: "POST",
								dataType: "JSON",
								data: {
									phone: inputPhone.value
								},
								success: function(res) {
									res = JSON.parse(res);
									nwaiting.close();
									btnAble2 = false;
									if (res.success) {
										plus.storage.setItem("authCodeTime", new Date().getTime().toString());
										plus.storage.setItem("authCodeToken", res.data.code_token);
										plus.storage.setItem("resPhone", inputPhone.value);
										timew.start();
										mui.toast("验证码已发送至您的手机上");
									} else {
										mui.toast(res.data.message || res.data.error || "服务器错误");
									}
								},
								error: function(xhr, type, errorThrown) {
									nwaiting.close();
									btnAble2 = false;
									var res = JSON.parse(xhr.response);
									if (typeof res.data.message !== "undefined") {
										mui.toast(res.data.message);
									}
								}
							});
						}
					}
				});
				//检查验证码
				function verifyAuthCode() {					
					var p = new Promise(function(resolve, reject) {
						var token = plus.storage.getItem("authCodeToken");
						var URL = "http://farm.rrzuji.com/v1/code/check?" + fnCreateSign() + "&code-token=" + token;
						mui.ajax(URL, {
							type: "POST",
							dataType: "JSON",
							data: {
								"code": inputAuthCode.value,
							},
							success: function(res) {
								console.log("提交验证码成功");
								res = JSON.parse(res);
								if (res.success) {
									plus.storage.setItem("securityToken", res.data.security_token);
									resolve(res.data.security_token);
								} else {
									mui.toast(res.data.message || res.data.error || "服务器错误");
								}
								btnAble = true;
							},
							error: function(xhr, type, errorThrown) {
								btnAble = true;
								try {
									var res = JSON.parse(xhr.response);
									if (typeof res.data.message !== "undefined") {
										mui.toast(res.data.message);
									}
								} catch (e) {
									mui.toast("服务器错误");
								}
							}
						});
					});
					return p;
				};
				//提交修改密码
				btnNext.addEventListener("tap", function() {					
					var newPWD = "";
					newPWD = pwdConfirm();
					if (!newPWD) {
						plus.nativeUI.alert("两次密码输入不一致", function() {}, "提示", "返回");
						return;
					}
					if (!btnAble) {
						return;
					}
					if (NetWorkStatus()) {
						return;
					}
					btnAble = false;
					// 提交修改密码申请
					verifyAuthCode().then(
						function(securityCode) {
							var nwaiting = plus.nativeUI.showWaiting("正在重置密码");
							var URL = "http://farm.rrzuji.com/v1/security/new-password?" + fnCreateSign() + "&security-token=" + securityCode;
							mui.ajax(URL, {
								type: "POST",
								dataType: "JSON",
								data: {
									"phone": inputPhone.value,
									"password": newPWD
								},
								success: function(res) {
									res = JSON.parse(res);
									nwaiting.close();
									btnAble = true;
									if (res.success) {
										mui.toast("重置密码成功");
										var w = plus.webview.getWebviewById("forgetPassword.html");
										w.hide("none");
										w.close();
									} else {
										mui.toast("重置密码失败" + res.data.message || res.data.error || "服务器错误");
									}
								},
								error: function(xhr, type, errorThrown) {
									nwaiting.close();
									btnAble2 = true;
									try {
										var res = JSON.parse(xhr.response);
										if (typeof res.data.message !== "undefined") {
											mui.toast("重置密码失败" + res.data.message);
										}
									} catch (e) {
										mui.toast("服务器错误");
									}
								}
							});
						}
					);
				});
				//提交密码end
			});
		</script>
	</body>

</html>