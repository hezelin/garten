<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="js/flexible_css.debug.js"></script>
		<script src="js/flexible.debug.js"></script>
		<script src="http://api.map.baidu.com/api?v=2.0&ak=iwvdqPIdPiGxdcqB2Tl28lLD"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<title>地图，浏览器定位</title>
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
			}
			
			.anchorBL {
				display: none;
			}
			
			#parkMap {
				bottom: 10px;
				left: 10px;
				top: auto;
				right: auto;
				position: absolute;
				z-index: 1100;
				background: rgba(255, 255, 255, 0.95);
				font-size: 16px;
				height: 24px;
				line-height: 24px;
				padding: 0 3px;
				border-radius: 3px;
				color: rgb(84, 90, 96);
			}
			
			#Myposition {
				bottom: 50px;
				left: 10px;
				top: auto;
				right: auto;
				position: absolute;
				z-index: 1100;
				background: rgba(255, 255, 255, 0.95);
				font-size: 16px;
				height: 24px;
				line-height: 24px;
				padding: 0 3px;
				border-radius: 3px;
				color: rgb(84, 90, 96);
			}
			
			.mui-icon {
				font-size: 20px;
				font-weight: 600;
			}
		</style>
	</head>

	<body>
		<!--<div class="header-control header-control-greenBold head-tab-hide header-control-fixed">
			<div class="header-control-left-btn">
				<span class="header-control-left-btn-span"></span>
				<span class="header-control-left-btn-span"></span>
			</div>
			<div>
				<span id="webview-head-title">地图</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span white-three-point-span"></span>
			</div>
		</div>-->
		<div id="map" style="width:100%;height: 100%; "></div>
		<div class="my-toast" id="myToast">
			<span class="my-toast-content"></span>
		</div>
		<div id="parkMap">公园地图 <span class="mui-icon mui-icon-map"></span></div>
		<div id="Myposition" data-switch="false">开启定位 <span class="mui-icon mui-icon-location"></span></div>
		<script src="js/mui.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			var first = null;
			mui.back = function() {
				if (mui.os.plus) {
					mui.fire(plus.webview.getWebviewById("HBuilder"), "backHome", {});
				}
			};
			var tileLayer = new BMap.TileLayer();
			var initPoint = new BMap.Point(117.936414, 24.580618);
			tileLayer.getTilesUrl = function(tileCoord, zoom) {
				var x = tileCoord.x;
				var y = tileCoord.y;
				return 'tiles/' + zoom + '/tile' + x + '_' + y + '.png';
			}
			var bmap = new BMap.Map('map', {
				minZoom: 12,
				maxZoom: 17
			});
			bmap.addTileLayer(tileLayer);
			bmap.addControl(new BMap.NavigationControl());
			bmap.centerAndZoom(initPoint, 16);
			document.getElementById("parkMap").addEventListener("tap", function() {
				stopLocaltion();
				bmap.panTo(initPoint);
			});
			mui.plusReady(function() {
				document.getElementById("Myposition").addEventListener("tap", function(e) {
					if (this.getAttribute("data-switch") == "false") {
						startLocation();
					} else {
						stopLocaltion();
					}
				});
			});
			var mapInterval = null;
			var marketFirst = null;
			var marker = null;
			var elem = document.getElementById("Myposition");

			function startLocation() {
				marketFirst = true;
				elem.innerHTML = "关闭定位 <span class='mui-icon mui-icon-location'></span>";
				elem.setAttribute("data-switch", "true");
				plus.geolocation.getCurrentPosition(function(p) {
					//						alert("Geolocation\nLatitude:" + p.coords.latitude + "\nLongitude:" + p.coords.longitude + "\nAltitude:" + p.coords.altitude);
					transform(p.coords.longitude, p.coords.latitude);
				}, function(e) {
					//						alert("Geolocation error: " + e.message);
				});
				mapInterval = window.setInterval(function() {
					plus.geolocation.getCurrentPosition(function(p) {
						//						alert("Geolocation\nLatitude:" + p.coords.latitude + "\nLongitude:" + p.coords.longitude + "\nAltitude:" + p.coords.altitude);
						transform(p.coords.longitude, p.coords.latitude);
					}, function(e) {
						//						alert("Geolocation error: " + e.message);
					});
				}, 3000);
			}

			function stopLocaltion() {
				marketFirst = false;
				elem.innerHTML = "开启定位 <span class='mui-icon mui-icon-location'></span>";
				elem.setAttribute("data-switch", "false");
				if (mapInterval) {
					window.clearInterval(mapInterval);
				}
			}

			function transform(lon, lat) {
				// 百度地图API功能
				//谷歌坐标
				var x = lon;
				var y = lat;
				var ggPoint = new BMap.Point(x, y);
				//地图初始化
				//				var bm = new BMap.Map("map");
				//				bmap.centerAndZoom(ggPoint, 15);
				bmap.addControl(new BMap.NavigationControl());
				translateCallback = function(data) {
					if (data.status === 0) {
						if (marketFirst) {
							marker = new BMap.Marker(data.points[0]);
							bmap.addOverlay(marker);
							marketFirst = false;
							bmap.setCenter(data.points[0]);
						} else {
							marker.setPosition(data.points[0]);
						}
						//						var label = new BMap.Label("你的位置", {
						//							offset: new BMap.Size(20, -10)
						//						});
						//						marker.setLabel(label); //添加百度label
						
					}
				}
				var convertor = new BMap.Convertor();
				var pointArr = [];
				pointArr.push(ggPoint);
				convertor.translate(pointArr, 3, 5, translateCallback)
			}
		</script>
	</body>

</html>