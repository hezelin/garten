<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="js/flexible_css.debug.js"></script>
		<script src="js/flexible.debug.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<title></title>
		<style>
			/*html,
			body {
				height: 100%;
			}*/
			
			.spinner {
				margin: 50% auto;
			}
		</style>
	</head>

	<body>
		<div class="header-control">
			<div class="header-control-left-btn  mui-action-back">
				<span class="white-arrow-big-span header-control-left-btn-span"></span>
			</div>
			<div>
				<span id="webview-head-title"></span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span"></span>
			</div>
		</div>

		<div class="header-control-tab-fixed" style="display: none;">
			<div class="header-control-tab">
				<div class="header-control-tab-nav header-control-tab-nav-active" data-transform="none" data-status="none">
					全部
				</div>
				<div class="header-control-tab-nav header-control-tab-nav-lay" data-transform="translateX(100%)" data-status="1">
					进行中
				</div>
				<div class="header-control-tab-nav header-control-tab-nav-lay" data-transform="translateX(200%)" data-status="10">
					已结束
				</div>
			</div>
			<div class="head-control-slider head-control-slider-3" style="transform: none">
			</div>
		</div>
		<!--<header class="mui-bar-nav"></header>
		<div class="mui-content"></div>-->

		<div class="loadingPage">
			<div class="loadingPage-middle">
				<div class="spinner">
					<div class="bounce1"></div>
					<div class="bounce2"></div>
					<div class="bounce3"></div>
				</div>
			</div>
		</div>

		<div class="my-toast" id="myToast">
			<span class="my-toast-content"></span>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			// 改变父模板页按钮等样式
			window.addEventListener("setHeadPage", function(event) {
				var newTitle = event.detail.title;
				var controlTab = event.detail.hasControlTab;
				var rightBtn = event.detail.rightBtn;
				//改变标题
				document.getElementById("webview-head-title").innerHTML = newTitle;
				//添加webview切换栏（订单
				if (controlTab) {
					document.getElementsByClassName("header-control-tab-fixed")[0].style.display = "block";
				}
				//添加按钮
				if (rightBtn) {
					//去除右侧按键的元素并填充
					var headRight = document.getElementsByClassName("header-control-right-btn")[0];
					if (headRight.firstChild) {
						headRight.removeChild(headRight.firstChild);
					}
					headRight.innerHTML = rightBtn;
				}
			});
			window.addEventListener("initHeadTemplate", function(e) {
				initHeadPage();
			});
			
			window.addEventListener("back", function() {
				mui.back();
			});
			
			window.addEventListener("openMyOrder", function() {				
				document.getElementById("webview-head-title").innerHTML = "我的订单";
				document.getElementsByClassName("header-control-tab-fixed")[0].style.display = "block";
				mui.trigger(document.querySelector(".header-control-tab-nav-active"), "tap");
			});
			
			window.addEventListener("avatarCrop", function(e) {
				document.getElementById("saveCrop").addEventListener("tap", function() {
					this.innerText = "···";
					mui.fire(plus.webview.getWebviewById("../crop/crop.html"), "saveCropAtCrop", {});
				});
			});
			window.addEventListener("avatarCropError", function(e) {
				document.getElementById("saveCrop").addEventListener("tap", function() {
					this.innerText = "保存";
				});
			});
			window.addEventListener("setCity", function(e) {
				document.getElementById("saveCity").addEventListener("tap", function() {
					mui.fire(plus.webview.getWebviewById("choiceAddress.html"), "saveCity", {});
				});
			});
			// 将模板页设为初始状态
			function initHeadPage() {
				//初始化订单页面导航栏
				var navNode = document.getElementsByClassName("header-control-tab-nav");
				for (var i = 0; i < navNode.length; i++) {
					if (navNode[i].classList.contains("header-control-tab-nav-active")) {
						navNode[i].classList.remove("header-control-tab-nav-active");
						navNode[i].classList.add("header-control-tab-nav-lay");
					}
				}
				navNode[0].classList.remove("header-control-tab-nav-lay");
				navNode[0].classList.add("header-control-tab-nav-active");
				var sliderBtn = document.getElementsByClassName("head-control-slider")[0];
				sliderBtn.style.transform = "none";
				sliderBtn.style.transitionDuration = "0ms";
				sliderBtn.style.webkitTransform = "none";
				sliderBtn.style.webkitTransitionDuration = "0ms";
				document.getElementsByClassName("header-control-tab-fixed")[0].style.display = "none";
				//去除头部栏右边按钮
				var headRight = document.getElementsByClassName("header-control-right-btn")[0];
				if (headRight.firstChild) {
					headRight.removeChild(headRight.firstChild);
				}
				//去除页面标题
				document.getElementById("webview-head-title").innerText = "";
			};
			/**
			 * @description 改变tab栏状态
			 * @param {Object} thisBtn
			 */
			function fnChangeTabStatus(thisBtn) {
				if (thisBtn.classList.contains("header-control-tab-nav-active")) {
					return;
				} else {
					var navNode = document.getElementsByClassName("header-control-tab-nav");
					for (var i = 0; i < navNode.length; i++) {
						if (navNode[i].classList.contains("header-control-tab-nav-active")) {
							navNode[i].classList.remove("header-control-tab-nav-active");
							navNode[i].classList.add("header-control-tab-nav-lay");
						}
					}
					thisBtn.classList.add("header-control-tab-nav-active");
					thisBtn.classList.remove("header-control-tab-nav-lay");
				}
			};
			mui.plusReady(function() {
				//webview切换栏
				mui(".header-control-tab").on("tap", ".header-control-tab-nav", function(e) {
					//					var thisBtn = this;
					//					var sliderBar = document.getElementsByClassName("head-control-slider")[0];
					//					var strValue = this.getAttribute("data-transform");
					//					sliderBar.style.transform = strValue;
					//					sliderBar.style.webkitTransform = strValue;
					//					sliderBar.style.transitionDuration = "200ms";
					//					sliderBar.style.webkitTransitionDuration = "200ms";
					//					var webviewBodyURL = "secondlv/webview-my-order.html";
					//					fnChangeTabStatus(thisBtn);
					//					if (thisBtn.classList.contains("loading")) {
					//						return;
					//					}
					//					thisBtn.classList.add("loading");
					//					var webviewHead = plus.webview.getWebviewById("webview-header");
					//					if (webviewHead.children().length > 0) {
					//						webviewHead.children()[0].close();
					//					}																			
					//					var webviewBody = plus.webview.create(webviewBodyURL, webviewBodyURL, fnSetSubpageStyle(217, 0), {});					
					//					webviewBody.onloaded = function() {
					//						mui.fire(webviewBody, "getData", {status: thisBtn.getAttribute("data-status")});
					//						thisBtn.classList.remove("loading");
					//						setTimeout(function() {
					//							webviewHead.append(webviewBody);
					//						}, 100);
					//					}
					var thisBtn = this;
					var sliderBar = document.getElementsByClassName("head-control-slider")[0];
					var strValue = this.getAttribute("data-transform");
					sliderBar.style.transform = strValue;
					sliderBar.style.webkitTransform = strValue;
					sliderBar.style.transitionDuration = "200ms";
					sliderBar.style.webkitTransitionDuration = "200ms";
					fnChangeTabStatus(thisBtn);
					var status = thisBtn.getAttribute("data-status");
					var _newView = mui.openWindow({
						url: "secondlv/webview-my-order.html",
						id: "secondlv/webview-my-order.html" + status,
						styles: fnSetSubpageStyle(217, 0),
						createNew: false,
						extras: {
							status: status
						},
						show: {
							autoShow: true,
							aniShow: "pop-in",
							duration: 300
						},
						waiting: {
							autoShow: true
						}
					});
					plus.webview.currentWebview().append(_newView);
//					var webviewBodyURL = "secondlv/webview-my-order.html";
//					if (thisBtn.classList.contains("loading")) {
//						return;
//					}
//					thisBtn.classList.add("loading");
//					var webviewHead = plus.webview.getWebviewById("webview-header");
//					for (var i in webviewHead.children()) {
//						webviewHead.children()[i].hide();
//					}
//					var webviewBody = plus.webview.create(webviewBodyURL, webviewBodyURL, fnSetSubpageStyle(217, 0), {});
//					webviewBody.onloaded = function() {
//						mui.fire(webviewBody, "getData", {
//							status: thisBtn.getAttribute("data-status")
//						});
//						thisBtn.classList.remove("loading");
//						setTimeout(function() {
//							webviewHead.append(webviewBody);
//						}, 100);
//					}
				});
				mui('.foot-control-bar').on('change', 'input', function() {
					var webBody = plus.webview.getWebviewById("webview-body");
					var value = this.checked ? "true" : "false";
					mui.fire(webBody, "fnCheckAll", {
						value: value
					});
				});
				//处理返回键事件
				var oldBack = mui.back;
				mui.back = function() {
					// 用以关闭订单页
					var webviewBody = plus.webview.currentWebview().children()[0];
					
					
					if (!webviewBody) {												
						oldBack();		
						initHeadPage();
						return;						
					}
					
					webviewBody.canBack(function(e) {
						var hasBack = e.canBack ? true : false;
						if (hasBack) {
							webviewBody.back();
						} else {
							initHeadPage();
							if (webviewBody.id == "secondlv/webview-my-collect.html" || webviewBody.id == "secondlv/webview-my-shopcar.html") {
								if (mui.os.plus) {
									var w = plus.webview.getWebviewById("webview-my.html");
									mui.fire(w, "setNum", {});
								}
							}
							oldBack();
						}
					});
				};
			});
		</script>
	</body>

</html>