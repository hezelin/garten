<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>我的 页面</title>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta http-equiv="content-security-policy">
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="js/flexible_css.debug.js"></script>
		<script src="js/flexible.debug.js"></script>

		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<style>
		</style>
	</head>

	<body>
		<div class="user-bg">
			<!--这里has-message/no-message-->
			<span class="no-message"></span>
			<img class="user-bg-img" id="userIMG" src="img/head.jpg" />
			</br>
			<span class="user-bg-name" id="userName">登录/注册</span>
			</br>
			<span class="user-bg-phone" id="userPhone"></span>
			<!--去掉小右箭头-->
			<!--<span class="user-bg-details white-arrow-span"></span>-->

			<div class="user-bg-nav">
				<a id="user-bag">
					<span class="user-bg-nav-counts" id="myBag">...</span></br>
					<span>我的红包</span>
				</a>
				<a class="short-line"><img id="r-border"></a>
				<a id="user-collect">
					<span class="user-bg-nav-counts" id="myCollect">...</span></br>
					<span>我的收藏</span>
				</a>
				<a class="short-line"><img id="l-border"></a>
				<a id="user-shop-car">
					<span class="user-bg-nav-counts" id="myShopCar">...</span></br>
					<span>购物车</span>
				</a>
			</div>
		</div>
		<div class="user-menu">
			<div class="user-menu-group" id="user-menu-group-orderform">
				<div class="user-menu-icon">
					<span class="my-orderform"></span>
				</div>
				<div class="user-menu-group-describle">
					<span>我的订单</span>
				</div>
				<div class="user-menu-group-describle-right">
					<span class="black-arrow-span"></span>
				</div>
			</div>
			<div class="user-menu-group" id="user-menu-group-myfarm">
				<div class="user-menu-icon">
					<span class="my-farm "></span>
				</div>
				<div class="user-menu-group-describle">
					<span>我的农场</span>
				</div>
				<div class="user-menu-group-describle-right">
					<span class="black-arrow-span"></span>
				</div>
			</div>
			<div class="user-menu-group" id="user-menu-group-myrequest">
				<div class="user-menu-icon">
					<span class="my-request"></span>
				</div>
				<div class="user-menu-group-describle">
					<span>我的社区</span>
				</div>
				<div class="user-menu-group-describle-right">
					<span class="black-arrow-span"></span>
				</div>
			</div>
			<div class="user-menu-group" id="user-menu-group-setting">
				<div class="user-menu-icon">
					<span class="my-setting"></span>
				</div>
				<div class="user-menu-group-describle">
					<span>设置</span>
				</div>
				<div class="user-menu-group-describle-right">
					<span class="black-arrow-span"></span>
				</div>
			</div>
		</div>

		<div class="my-toast" id="myToast">
			<span class="my-toast-content"></span>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			var first = null;
			mui.back = function() {
				if (mui.os.plus) {
					mui.fire(plus.webview.getWebviewById("HBuilder"), "backHome", {});
				}
			};
			//  获取红包、收藏、购物车数量，并更新面板
			var myBag = document.getElementById("myBag");
			var myCollect = document.getElementById("myCollect");
			var myShopCar = document.getElementById("myShopCar");

			function setNum() {
				var token = plus.storage.getItem("tokenValue");
				if (!token) {
					// 未登录
					myBag.innerText = "...";
					myCollect.innerText = "...";
					myShopCar.innerText = "...";
					return;
				}
				var URL = "http://farm.rrzuji.com/v1/user/num?" + fnCreateSign() + "&access-token=" + token;
				mui.ajax(URL, {
					type: "GET",
					dataType: "JSON",
					success: function(res) {
						res = JSON.parse(res);
						if (res.success) {
							myBag.innerText = res.data.hongbao_num;
							myCollect.innerText = res.data.collect_num;
							myShopCar.innerText = res.data.cart_num;
							console.log("红包"+res.data.hongbao_num+" 收藏"+res.data.collect_num+" 购物车"+res.data.cart_num);
						}
					},
					error: function(xhr, type, errorThrown) {
						myBag.innerText = "...";
						myCollect.innerText = "...";
						myShopCar.innerText = "...";
						console.log(JSON.stringify(xhr));
						try {
							var res = JSON.parse(xhr.response);
							if (typeof res.data.message !== "undefined") {
								console.log("调试信息，获取红包收藏购物车数量失败" + res.data.message);
							}
						} catch (e) {
							console.log("调试信息，获取红包收藏购物车数量失败，服务器错误");
						}
					}
				});
			}
			// 更新个人中心面板 ，节点id，节点id
			function updateUserInfo(nameDomID, phoneDomID) {
				var name = plus.storage.getItem("userName");
				var phone = plus.storage.getItem("userPhone");
				if (name != null && phone != null) {
					document.getElementById(nameDomID).innerText = name;
					document.getElementById(phoneDomID).innerText = phone;
				} else {
					document.getElementById(nameDomID).innerText = "登录/注册";
					document.getElementById(phoneDomID).innerText = "";
				}
			}
			// 更新个人头像
			function updateAvatar() {
				if (NetWorkStatus()) {
					return;
				}
				var URL = plus.storage.getItem("userAvatar");
				if (URL == null) {
					return;
				}
				console.log("开始更新头像");
				var dtask = plus.downloader.createDownload(URL, {
					filename: "_doc/head.jpg"
				}, function(d, status) {
					// 下载完成
					if (status == 200) {
						console.log("头像下载成功: " + d.filename);
						defaultImg("userIMG", "../www/img/head.jpg");
					} else {
						console.log("头像下载失败: " + status);
						defaultImg("userIMG", "../www/img/head.jpg");
					}
				});
				//dtask.addEventListener( "statechanged", onStateChanged, false );				
				dtask.start();
			}
			// 获取通知
			function getNoice() {
				//				console.log("获取通知，未开发");
			}
			// 更新面板昵称、手机
			window.addEventListener("changeNameOrPhone", function() {
				updateUserInfo("userName", "userPhone");
			});
			// 设置头像截图成功后
			// 更新面板头像
			window.addEventListener("changeAvatar", function() {
				defaultImg("userIMG", "../www/img/head.jpg");
			});
			// 更新面板 & 初始化面板
			window.addEventListener("changeInfo", function() {
				updateUserInfo("userName", "userPhone");
				defaultImg("userIMG", "../www/img/head.jpg");
				setNum();
				getNoice();
			});
			// 登录后的操作
			window.addEventListener("changeInfoLogin", function() {
				updateUserInfo("userName", "userPhone");
				updateAvatar();
				setNum();
				getNoice();
			});
			// 切换tab时， 获取收藏数量及通知
			window.addEventListener("setNum", function() {
				setNum();
				getNoice();
			});
			mui.plusReady(function() {
				// app打开后
				if (userLoginStatus()) {
					//如果已登录，页面加载完成后设置面板，获取数量，设置头像
					updateUserInfo("userName", "userPhone");
					defaultImg("userIMG", "../www/img/head.jpg");
					setNum();
					getNoice();
				}
				document.querySelector(".user-bg-name").addEventListener("tap", function() {
					if (!userLoginStatus()) {
						openLogin(this);
					}
				});
				//打开我的红包
				document.getElementById("user-bag").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					fnLoadPage(e.currentTarget, {
						url: "secondlv/webview-my-userbag.html",
						top: 98,
						bottom: 0
					}, {
						title: "我的红包"
					});
				});
				//打开收藏
				document.getElementById("user-collect").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					fnLoadPage(e.currentTarget, {
						url: "secondlv/webview-my-collect.html",
						top: 98,
						bottom: 0
					}, {
						title: "我的收藏"
					});
				});
				//打开购物车
				document.getElementById("user-shop-car").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					fnLoadPage(e.currentTarget, {
						url: "secondlv/webview-my-shopcar.html",
						top: 98,
						bottom: 0
					}, {
						title: "购物车",
						rightBtn: "<span class='header-control-right-btn-span' ></span>"
					});
				});
				//打开我的订单
				document.getElementById("user-menu-group-orderform").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					//订单窗口有头部导航
					fnLoadPage(e.currentTarget, {
						url: "secondlv/webview-my-order.html",
						top: 213,
						bottom: 0
					}, {
						title: "我的订单",
						hasControlTab: true
					});
				});
				//打开我的农场
				document.getElementById("user-menu-group-myfarm").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					//订单窗口有头部导航
					fnLoadPage(e.currentTarget, {
						url: "webview-body.html",
						top: 98,
						bottom: 0
					}, {
						title: "我的农场"
					});
				});
				//打开我的社区
				document.getElementById("user-menu-group-myrequest").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					showWebviewCOM(plus.webview.currentWebview(), "secondlv/webview-my-comu.html", {
						func: "initPage",
						detail: {
							tokenValue: plus.storage.getItem("tokenValue")
						}
					});
					//					mui.openWindow({
					//						url: "secondlv/webview-my-comu.html",
					//						id: "secondlv/webview-my-comu.html",
					//						styles: fnSetSubpageStyle(0, 0),
					//						createNew: false,
					//						show: {
					//							autoShow: true,
					//							aniShow: "pop-in",
					//							duration: 300
					//						},
					//						waiting: {
					//							autoShow: true
					//						}
					//					});
				});
				//打开设置
				document.getElementById("user-menu-group-setting").addEventListener("tap", function(e) {
					if (!userLoginStatus()) {
						openLogin(this);
						return;
					}
					var btn = this;
					if (btn.classList.contains("loading")) {
						return;
					}
					this.classList.add("loading");
					var webviewSpa = plus.webview.create("secondlv/webview-my-setting.html", "secondlv/webview-my-setting.html", {
						hardwareAccelerated: true
					});
					webviewSpa.onloaded = function() {
						webviewSpa.show("pop-in", "300", function() {
							btn.classList.remove("loading");
						});
					};
				});
			});
		</script>
	</body>

</html>