<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<script src="../js/flexible_css.debug.js"></script>
		<script src="../js/flexible.debug.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/style.css" rel="stylesheet" />
		<style>
			.mui-pull-top-tips {
				position: absolute;
				top: -20px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			
			.mui-bar~.mui-pull-top-tips {
				top: 24px;
			}
			
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			
			.mui-pull-top-tips .mui-pull-loading {
				/*-webkit-backface-visibility: hidden;
				-webkit-transition-duration: 400ms;
				transition-duration: 400ms;*/
				margin: 0;
			}
			
			.mui-pull-top-wrapper .mui-icon,
			.mui-pull-top-wrapper .mui-spinner {
				margin-top: 7px;
			}
			
			.mui-pull-top-wrapper .mui-icon.mui-reverse {
				/*-webkit-transform: rotate(180deg) translateZ(0);*/
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			
			.mui-pull-top-canvas {
				overflow: hidden;
				background-color: #fafafa;
				border-radius: 40px;
				box-shadow: 0 4px 10px #bbb;
				width: 40px;
				height: 40px;
				margin: 0 auto;
			}
			
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			
			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="header-control">
				<div class="header-control-left-btn  mui-action-back">
					<span class="white-arrow-big-span header-control-left-btn-span"></span>
				</div>
				<div>
					<span id="webview-head-title">商城</span>
				</div>
				<div class="header-control-right-btn">
					<span class="header-control-right-btn-span search-span"></span>
				</div>
			</div>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider mui-fullscreen">
				<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<a class="mui-control-item mui-active" href="#item1mobile" data-id="hotSaleList" data-scroll-id="hotSaleScroll" data-first="false">
						热销
					</a>
					<a class="mui-control-item" href="#item2mobile" data-id="flowerList" data-scroll-id="flowerScroll" data-first="true">
						花卉
					</a>
					<a class="mui-control-item" href="#item3mobile" data-id="vegetableList" data-scroll-id="vegetableScroll" data-first="true">
						蔬菜
					</a>
					<a class="mui-control-item" href="#item4mobile" data-id="fruitList" data-scroll-id="fruitScroll" data-first="true">
						水果
					</a>
					<a class="mui-control-item" href="#item5mobile" data-id="meatList" data-scroll-id="meatScroll" data-first="true">
						肉类
					</a>
					<a class="mui-control-item" href="#item6mobile" data-id="otherList" data-scroll-id="otherScroll" data-first="true">
						其他
					</a>
				</div>
				<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-2"></div>

				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll" id="hotSaleScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="hotSaleList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" id="flowerScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="flowerList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="item3mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" id="vegetableScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="vegetableList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="item4mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" id="fruitScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="fruitList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="item5mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" id="meatScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="meatList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div id="item6mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll" id="otherScroll">
								<div class="spinner" style="display: block;">
									<div class="bounce1"></div>
									<div class="bounce2"></div>
									<div class="bounce3"></div>
								</div>
								<div class="shopping-list-tab-container" id="otherList">
									<div class="shopping-list-item" v-cloak v-for="item in data.items" data-id="{{item.id}}" data-shop-id="item.shop_id" v-on:tap="openDetail">
										<div class="shopping-list-item-bg" style="background: url({{item.cover}}); background-size: cover;"></div>
										<div class="shopping-list-item-title">
											<span class="shopping-list-item-title-span">{{item.title}}</span>
										</div>
										<div class="shopping-list-item-store">
											<div class="shopping-list-item-store-left">
												<span class="shop-span"></span>
												<span class="shopping-list-item-store-name">{{item.shop_name}}</span>
											</div>
											<div class="shopping-list-item-store-right">
												<span class="shopping-list-item-store-price">&yen;<em>{{item.price}}</em></span>
											</div>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="my-toast" id="myToast">
			<span class="my-toast-content"></span>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/md5.min.js"></script>
		<script src="../js/vue.min.js"></script>
		<script src="../js/public.js"></script>
		<script src="../js/mui.pullToRefresh.js"></script>
		<script src="../js/mui.pullToRefresh.material.js"></script>
		<script>
			// 系统页面初始化
			mui.init();
			//阻尼系数
			var deceleration = mui.os.ios ? 0.003 : 0.0009;
			mui('.mui-scroll-wrapper').scroll({
				bounce: false,
				indicators: true, //是否显示滚动条
				deceleration: deceleration
			});
			// 请求相关url
			var url = {
				"hotSaleList": "http://farm.rrzuji.com/v1/items?category=20&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
				"flowerList": "http://farm.rrzuji.com/v1/items?category=21&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
				"vegetableList": "http://farm.rrzuji.com/v1/items?category=22&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
				"fruitList": "http://farm.rrzuji.com/v1/items?category=23&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
				"meatList": "http://farm.rrzuji.com/v1/items?category=24&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
				"otherList": "http://farm.rrzuji.com/v1/items?category=25&fields=id,shop_id,shop_name,shop_image,title,cover,price,high_price",
			}
			var tabObj = function(IDlist, IDscroll, isFirst) {
				this.list_ID = IDlist;
				this.refreshContainer = mui(document.getElementById(IDscroll));
				this.first = isFirst;
				this.page = 1;
				this.url = url[IDlist] + "&page=";
				this.refreshSign = "";
				this.vueObj = null;
				this.spinner = document.querySelector("#" + IDscroll + " .spinner");
				this.init();
			}
			tabObj.prototype = {
				init: function() {
					if (this.first == "false") {
						return;
					}
					console.log("初始化");
					this.bindVue();
					this.getData();
				},
				initPullRefresh: function() {
					var thisObj = this;
					thisObj.refreshContainer.pullToRefresh({
						down: {
							callback: function() {
								thisObj.refreshSign = "down";
								thisObj.page = 1;
								thisObj.getData();
							}
						},
						up: {
							callback: function() {
								thisObj.refreshSign = "up";
								thisObj.getData();
							}
						}
					});
				},
				dealFirst: function(data) {
					var thisObj = this;
					try {
						thisObj.first = "false";
						// 整体更换初始化vue数据
						thisObj.vueObj.$data = data;
						thisObj.vueObj.$nextTick(function() {
							thisObj.spinner.style.display = "none";
							thisObj.initPullRefresh();
							thisObj.noMore(data);
						});
					} catch (err) {
						console.log(err);
					}
				},
				getData: function() {
					if (NetWorkStatus()) {
						return;
					}
					var URL = this.url + this.page + "&" + fnCreateSign();
					var thisObj = this;
					mui.ajax(URL, {
						type: "GET",
						dataType: "JSON",
						timeout: 15000,
						success: function(res) {
							console.log("获取到的列表数据" + res);
							res = JSON.parse(res);
							if (res.success) {
								thisObj.page++;
								// 第一次获取数据后的处理
								if (thisObj.first == "true") {
									thisObj.dealFirst(res);
								} else {
									// 不是第一次
									if (thisObj.refreshSign == "up") {
										console.log(2);
										for (var i = 0; i < res.data.items.length; i++) {
											thisObj.vueObj.data.items.push(res.data.items[i]);
										}
										if (thisObj.noMore(res)) {
											return;
										};
									} else {
										thisObj.vueObj.$data = res;
										thisObj.refreshContainer.pullToRefresh().endPullDownToRefresh();
										thisObj.refreshContainer.pullToRefresh().refresh(true);
										thisObj.noMore(res);
										return;
									}
								}
							}
							thisObj.stopRefresh();
						},
						error: function(xhr, type, errorThrown) {
							ajaxError(xhr);
							thisObj.stopRefresh();
							mui.toast("加载失败，请检查您的网络");
						}
					});
				},
				noMore: function(res) {
					var thisObj = this;
					console.log(JSON.stringify(res));
					if (res.data._meta.currentPage == res.data._meta.pageCount || res.data._meta.pageCount == 0) {
						thisObj.refreshContainer.pullToRefresh().endPullUpToRefresh(true);
						return true;
					}
				},
				stopRefresh: function(self) {
					var sign = this.refreshSign;
					// 没有更多数据的话，refresh设置true
					if (sign == "down") {
						this.refreshContainer.pullToRefresh().endPullDownToRefresh();
					}
					if (sign == "up") {
						this.refreshContainer.pullToRefresh().endPullUpToRefresh();
					}
				},
				bindVue: function() {
					// 绑定vue
					var thisObj = this;
					thisObj.vueObj = new Vue({
						el: "#" + thisObj.list_ID,
						data: {},
						methods: {
							openDetail: function(event) {
								var thisBtn = event.currentTarget;
								var _id = thisBtn.getAttribute("data-id");
								mui.openWindow({
									url: "../thirdlv/webview-trade-detail.html",
									styles: fnSetSubpageStyle(0, 0),
									createNew: false,
									extras: {
										itemID: _id
									},
									show: {
										autoShow: true,
										aniShow: "pop-in",
										duration: 300
									},
									waiting: {
										autoShow: true
									}
								});
							}
						}
					})
				}
			}
			mui.plusReady(function() {
				// 第一个标签手动设置				
				new tabObj("hotSaleList", "hotSaleScroll", "true");
				document.getElementById("slider").addEventListener("scrollend", function() {
					var elem = document.querySelector("#sliderSegmentedControl .mui-active");
					var first = elem.getAttribute("data-first");
					if (first == "true") {
						new tabObj(elem.getAttribute("data-id"), elem.getAttribute("data-scroll-id"), first);
						elem.setAttribute("data-first", "false");
					}
				})
			});
		</script>
	</body>

</html>