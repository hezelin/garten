<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<script src="js/flexible_css.debug.js"></script>
		<script src="js/flexible.debug.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<title></title>
		<style>
			.head-tab-active {
				display: table;
			}
			
			.head-tab-hide {
				display: none;
			}
			
			#pull {
				width: 24px;
				height: 100%;
				display: inline-block;
				margin: 0 1em;
			}
			
			#icon {
				height: 24px;
				vertical-align: middle;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
		</style>
	</head>

	<body>
		<div class="header-control header-control-greenBold head-tab-active" id="home-header-control">
			<div class="header-control-left-btn app-log-div">
				<span class="app-log-span header-control-left-btn-span"></span>
			</div>
			<div class="header-control-app-name">
				<span id="webview-head-title">曦山农场</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span search-span"></span>
				<span class="header-control-right-btn-span white-three-point-span"></span>
			</div>
		</div>
		<div class="header-control header-control-greenBold head-tab-hide">
			<div class="header-control-left-btn">
				<span class="app-log-span header-control-left-btn-span"></span>
				<!--<span class="white-arrow-big-span header-control-left-btn-span"></span>-->
			</div>
			<div>
				<span id="webview-head-title">社区</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span white-three-point-span"></span>
			</div>
		</div>
		<div class="header-control header-control-greenBold head-tab-hide">
			<div class="header-control-left-btn">
				<span class="app-log-span header-control-left-btn-span"></span>
				<!--<span class="white-arrow-big-span header-control-left-btn-span"></span>-->
			</div>
			<div>
				<span id="webview-head-title">地图</span>
			</div>
			<div class="header-control-right-btn">
				<span class="header-control-right-btn-span white-three-point-span"></span>
			</div>
		</div>
		<div style="text-align:center;height:44px;line-height:44px; background-color: #FFFFFF;">
			<div id="pull"><img id="icon" src="img/pull_arrow.png" /></div><font id="text">下拉可刷新</font>
		</div>
		<!--底部nav栏-->
		<div id="index-bar-tab">
			<div id="home" class="index-tab-item index-tab-active" data-href="webview-home.html">
				<span class="icon-index icon-index-home"></span>
				<span class="icon-label">首页</span>
			</div>
			<div id="comu" class="index-tab-item" data-href="webview-comu.html">
				<span class="icon-index icon-index-comu"></span>
				<span class="icon-label">社区</span>
			</div>
			<div id="map" class="index-tab-item" data-href="webview-nav.html">
				<span class="icon-index icon-index-nav"></span>
				<span class="icon-label">地图</span>
			</div>
			<div id="my" class="index-tab-item" data-href="webview-my.html">
				<span class="icon-index icon-index-info"></span>
				<span class="icon-label">我的</span>
			</div>
		</div>

		<script src="js/mui.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			// 初始化
			// webview-my页要放在最后
			var subpages = ['webview-home.html', 'webview-comu.html', 'webview-nav.html', 'webview-my.html'];
			// 默认激活标签
			var activeTab = "webview-home.html";
			
			
			//\\
			var etext = null,
					eicon = null;
				etext = document.getElementById("text");
				eicon = document.getElementById("icon");
			function pullReset() {
					etext.innerText = "下拉可刷新";
					eicon.src = "img/pull_arrow.png";
					eicon.style.webkitTransition = "";
					eicon.style.webkitTransform = "";
					eicon.style.webkitAnimation = "";
			}
			mui.plusReady(function() {
				
				//	var ws = plus.webview.currentWebview();
				function fnPullRefresh() {
					var ws = plus.webview.getWebviewById("webview-home.html");
					ws.addEventListener("dragBounce", onPullStateChange, false);
					ws.setBounce({
						position: {
							top: "100px"
						},
						changeoffset: {
							top: "50px"
						}
					});

					function onPullStateChange(e) {
						switch (e.status) {
							case "beforeChangeOffset": //下拉可刷新状态
								pull1();
								break;
							case "afterChangeOffset": //松开可刷新状态
								pull2();
								break;
							case "dragEndAfterChangeOffset": //正在刷新状态
								ws.evalJS("onRefresh();");
								pull3();
								break;
							default:
								break;
						}
					}
				}

				function pull1() {
					etext.innerText = "下拉可刷新";
					eicon.style.webkitTransition = "all 0.3s ease-in";
					eicon.style.webkitTransform = "rotate(0deg)";
				}

				function pull2() {
					etext.innerText = "松开可刷新";
					eicon.style.webkitTransition = "all 0.3s ease-in";
					eicon.style.webkitTransform = "rotate(180deg)";
				}

				function pull3() {
					etext.innerText = "正在刷新...";
					eicon.src = "img/pull_fresh.png";
					eicon.style.webkitAnimation = "spin 1s infinite linear";
				}

				
				//\\
				// 仅支持竖屏显示
				plus.screen.lockOrientation("portrait-primary");
				// 打开app时马上更新本地储存区
				var token = plus.storage.getItem("tokenValue");
				var userID = plus.storage.getItem("userID");
				if (userLoginStatus() && token && userID) {
					var URL = "http://farm.rrzuji.com/v1/users/" + userID + "?" + fnCreateSign() + "&access-token=" + token;
					mui.ajax(URL, {
						type: "GET",
						dataType: "JSON",
						success: function(res) {
							console.log("打开app后刷新本地缓存" + res);
							res = JSON.parse(res);
							if (res.success) {
								plus.storage.setItem("userID", res.data.id.toString());
								plus.storage.setItem("userName", res.data.name);
								plus.storage.setItem("userPhone", res.data.phone);
								plus.storage.setItem("userAvatar", res.data.avatar);
								if (res.data.gender) {
									plus.storage.setItem("userGender", res.data.gender.toString());
								}
							} else {
								plus.storage.clear();
							}
						},
						error: function(xhr, type, errorThrown) {
							console.log(JSON.stringify(xhr));
							console.log("打开app时刷新本地储存失败");
						}
					});
				}
				var aniShow = {};
				var loadCount = subpages.length;
				var self = plus.webview.currentWebview();

				function fnCloseSplashScreen(loadCount) {
					if (loadCount == 0) {
						plus.navigator.closeSplashscreen();
						var webHead = mui.preload({
							url: "webview-header.html",
							id: "webview-header",
							styles: fnSetSubpageStyle(0, 0)
						});
						var tradeHead = mui.preload({
							url: "webview-trade-header.html",
							id: "webview-trade-header",
							styles: fnSetSubpageStyle(0, 0)
						});
						var shophead = mui.preload({
							url: "webview-shop-header.html",
							id: "webview-shop-header",
							styles: fnSetSubpageStyle(0, 0)
						});
					}
				}
				for (var i = 0; i < subpages.length; i++) {
					if (i == subpages.length - 1) {
						fnPullRefresh();
						var sub = plus.webview.create(subpages[i], subpages[i], fnSetSubpageStyle(0, 101));
						sub.onloaded = function() {
							loadCount--;
							fnCloseSplashScreen(loadCount);
							plus.webview.show("webview-home.html", "none");
							console.log("调试信息：" + (userLoginStatus() ? "已登录" : "未登录"));
						};
					} else {
						var sub = plus.webview.create(subpages[i], subpages[i], fnSetSubpageStyle(98, 101));
						sub.onloaded = function() {
							loadCount--;
							fnCloseSplashScreen(loadCount);
						};
					}
				}
				// 选项卡点击事件
				var headElem = document.getElementsByClassName("header-control");
				mui("#index-bar-tab").on("tap", ".index-tab-item", function(e) {
					var targetTab = this.getAttribute("data-href");
					if (targetTab == activeTab) {
						return;
					}
					// 更换状态
					document.querySelector(".index-tab-active").classList.remove("index-tab-active");
					this.classList.add("index-tab-active");
					// 如果已登录且是个人中心页面，则获取通知
					if (targetTab == "webview-my.html" && userLoginStatus()) {
						mui.fire(plus.webview.getWebviewById(targetTab), "setNum", {});
					}
					if (targetTab == "webview-home.html") {
						var oldElem = document.getElementsByClassName("head-tab-active")[0].classList;
						oldElem.remove("head-tab-active");
						oldElem.add("head-tab-hide");
						headElem[0].classList.add("head-tab-active");
						headElem[0].classList.remove("head-tab-hide");
					}
					if (targetTab == "webview-comu.html") {
						var oldElem = document.getElementsByClassName("head-tab-active")[0].classList;
						oldElem.remove("head-tab-active");
						oldElem.add("head-tab-hide");
						headElem[1].classList.add("head-tab-active");
						headElem[1].classList.remove("head-tab-hide");
					}
					if (targetTab == "webview-nav.html") {
						var oldElem = document.getElementsByClassName("head-tab-active")[0].classList;
						oldElem.remove("head-tab-active");
						oldElem.add("head-tab-hide");
						headElem[2].classList.add("head-tab-active");
						headElem[2].classList.remove("head-tab-hide");
					}
					plus.webview.hide(activeTab);
					plus.webview.show(targetTab);
					activeTab = targetTab;
				});
			});
		</script>
	</body>

</html>