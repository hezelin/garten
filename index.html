<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<script src="js/flexible_css.debug.js"></script>
		<script src="js/flexible.debug.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<title></title>
		<style>
			.head-tab-active {
				display: table;
			}
			
			.head-tab-hide {
				display: none;
			}
			
			#pull {
				width: 24px;
				height: 100%;
				display: inline-block;
				margin: 0 1em;
			}
			
			#icon {
				height: 24px;
				vertical-align: middle;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
		</style>
	</head>

	<body>
		<!--底部nav栏-->
		<div id="index-bar-tab">
			<div id="home" class="index-tab-item index-tab-active" data-href="webview-home-header.html">
				<span class="icon-index icon-index-home"></span>
				<span class="icon-label">首页</span>
			</div>
			<div id="comu" class="index-tab-item" data-href="webview-comu-new.html">
				<span class="icon-index icon-index-comu"></span>
				<span class="icon-label">社区</span>
			</div>
			<div id="map" class="index-tab-item" data-href="webview-map.html">
				<span class="icon-index icon-index-nav"></span>
				<span class="icon-label">地图</span>
			</div>
			<div id="my" class="index-tab-item" data-href="webview-my.html">
				<span class="icon-index icon-index-info"></span>
				<span class="icon-label">我的</span>
			</div>
		</div>

		<script src="js/mui.min.js"></script>
		<script src="js/md5.min.js"></script>
		<script src="js/public.js"></script>
		<script>
			mui.init();
			// 初始化
			// webview-my页要放在最后， 并且要与html中data-href统一
			var subpages = ['webview-home-header.html', 'webview-comu-new.html', 'webview-map.html', 'webview-my.html'];
			// 默认激活标签
			var activeTab = "webview-home-header.html";
			// 供其他三个平级页面调用
			window.addEventListener("backHome", function() {
				var btn = document.getElementById("home");
				mui.trigger(btn, "tap");
			});
			mui.plusReady(function() {
				// 仅支持竖屏显示
				plus.screen.lockOrientation("portrait-primary");
				// 打开app时马上更新本地储存区
				var token = plus.storage.getItem("tokenValue");
				var userID = plus.storage.getItem("userID");
				if (userLoginStatus() && token && userID) {
					var URL = "http://farm.rrzuji.com/v1/users/" + userID + "?" + fnCreateSign() + "&access-token=" + token;
					mui.ajax(URL, {
						type: "GET",
						dataType: "JSON",
						success: function(res) {
							console.log("打开app后刷新本地缓存" + res);
							res = JSON.parse(res);
							if (res.success) {
								plus.storage.setItem("userID", res.data.id.toString());
								plus.storage.setItem("userName", res.data.name);
								plus.storage.setItem("userPhone", res.data.phone);
								plus.storage.setItem("userAvatar", res.data.avatar);
								if (res.data.gender) {
									plus.storage.setItem("userGender", res.data.gender.toString());
								}
							} else {
								plus.storage.clear();
							}
						},
						error: function(xhr, type, errorThrown) {
							console.log(JSON.stringify(xhr));
							console.log("打开app时刷新本地储存失败");
						}
					});
				}
				var aniShow = {};
				var loadCount = subpages.length;
				var self = plus.webview.currentWebview();

				function fnCloseSplashScreen(loadCount) {
					if (loadCount == 0) {						
						var webHead = mui.preload({
							url: "webview-header.html",
							id: "webview-header",
							styles: fnSetSubpageStyle(0, 0)
						});
						var tradeHead = mui.preload({
							url: "webview-trade-header.html",
							id: "webview-trade-header",
							styles: fnSetSubpageStyle(0, 0)
						});
						var shophead = mui.preload({
							url: "webview-shop-header.html",
							id: "webview-shop-header",
							styles: fnSetSubpageStyle(0, 0)
						});
					}
				}
				for (var i = 0; i < subpages.length; i++) {
					if (i == subpages.length - 1) {
//						plus.webview.currentWebview().onloaded = function() {
//					plus.navigator.closeSplashscreen();
//				}
						var sub = plus.webview.create(subpages[i], subpages[i], fnSetSubpageStyle(0, 101));
						sub.onloaded = function() {
							loadCount--;
							fnCloseSplashScreen(loadCount);
							plus.webview.show("webview-home-header.html", "none");
							console.log("调试信息：" + (userLoginStatus() ? "已登录" : "未登录"));
						};
					} else {
						var sub = plus.webview.create(subpages[i], subpages[i], fnSetSubpageStyle(0, 102));		
						sub.onloaded = function() {
							loadCount--;
							fnCloseSplashScreen(loadCount);
						};
					}
				}
				// 选项卡点击事件
				var headElem = document.getElementsByClassName("header-control");
				mui("#index-bar-tab").on("tap", ".index-tab-item", function(e) {
					var targetTab = this.getAttribute("data-href");
					if (targetTab == activeTab) {
						return;
					}					
					// 更换状态
					document.querySelector(".index-tab-active").classList.remove("index-tab-active");
					this.classList.add("index-tab-active");
					// 如果已登录且是个人中心页面，则获取通知
					if (targetTab == "webview-my.html" && userLoginStatus()) {
						mui.fire(plus.webview.getWebviewById(targetTab), "setNum", {});
					}
					// 如果是社区页，则初始化
					if (targetTab == "webview-comu-new.html") {
						mui.fire(plus.webview.getWebviewById(targetTab), "initPage", {});
					}
					plus.webview.hide(activeTab);
					plus.webview.show(targetTab);
					activeTab = targetTab;					
				});
			});
			
		</script>
	</body>

</html>